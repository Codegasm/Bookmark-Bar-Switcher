<html>
	<head>
		<link type="text/css" rel="stylesheet" href="style.css" />
		<script>
			function initView() {
				// Request the data from the background page.
				chrome.extension.getBackgroundPage().loadData(populate);
			}

			/**
			 * As the name suggests this function populates the view with the
			 * available bookmark bars. It highlights the one thats is in use.
			 **/
			function populate(bookmarkBars, currentBB) {
				// Build an array with the new list items.
				var ulItems = [];
				bookmarkBars.forEach(function(item) {
					if(item == currentBB) {
						ulItems.push('<li class="current">' + item + '</li>');
					} else {
						ulItems.push('<li onclick="selectBookmarkBar(\'' + item + '\')">' + item + '</li>');
					}
				});

				var list = document.getElementById("popup_list");
				list.innerHTML = ulItems.join("");
			}

			/**
			 * Handles the new bookmark bar form by taking the name and calling the 
			 * newBar() method on the background page. If no name was provided an 
			 * error is displayed. The newBar() method will return an error if
			 * the name is taken. For the sake of simplicity newBar() returns an 
			 * error string if something went wrong and null otherwise.
			 **/
			function createBar() {
				var name = document.getElementById("barName").value;

				if(name.indexOf(":") != -1) {
					showError("The name can't contain a colon (:).");
				} else if(name.length > 0) {
					chrome.extension.getBackgroundPage().newBar(name, barCreated);
				} else {
					showError("Please provide a name.");
				}
			}

			/**
			 * Receives the result of creating a new bookmark bar. If there was an
			 * error it will receive a string to display, otherwise it will be null.
			 **/
			function barCreated(message) {
				if(message != null) {
					showError(message);
				} else {
					hidePopup();
				}
			}

			/**
			 * Convenience method which closes the popup. 
			 **/
			function hidePopup() {
				javascript:window.close();
			}

			/**
			 * Shows the error area with the specified message.
			 **/
			function showError(message) {
				var errorField = document.getElementById("error");
				errorField.innerHTML = message;
				errorField.style.display = "block";
			}

			/**
			 * Shows the new bookmark bar form.
			 **/
			function showNameForm() {
				var nameFormDiv = document.getElementById("barNameDiv");
				nameFormDiv.style.display = "block";

				document.getElementById("barName").focus();
			}

			/**
			 * Tells the background page to switch to the specified bookmark bar.
			 **/
			function selectBookmarkBar(bar) {
				chrome.extension.getBackgroundPage().selectBar(bar);
				hidePopup();
			}
		</script>	
	</head>
	<body onload="initView()">
		<ul id="popup_list">
		</ul>
		<ul id="command_list">
			<li onclick="showNameForm(); this.className += ' current';">New bar</li>	
		</ul>
		<div id="barNameDiv">
			<form id="barNameForm" onsubmit="createBar()">
				<label for="barName">Name:</label>
				<input type="text" size="10" id="barName" />
				<input type="button" value="Cancel" onclick="hidePopup()" />
				<input type="button" value="OK" onclick="createBar()" />
			</form>
		</div>
		<div id="error"></div>
	</body>
</html>
